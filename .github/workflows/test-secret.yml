name: Test DeepSeek Secret

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æµ‹è¯•ç±»åž‹'
        required: false
        default: 'simple'
        type: choice
        options:
          - simple
          - api

env:
  PYTHON_VERSION: '3.11'

jobs:
  test-secret:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Test Secret Availability
        env:
          TEST_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          echo "ðŸ” æµ‹è¯•GitHub Secret..."
          echo "========================"
          
          if [ -z "$TEST_KEY" ]; then
            echo "âŒ é”™è¯¯: DEEPSEEK_API_KEYæœªè®¾ç½®æˆ–ä¸ºç©º"
            echo ""
            echo "å½“å‰çŠ¶æ€:"
            echo "  Secretåç§°: DEEPSEEK_API_KEY"
            echo "  Secretå€¼: [ç©º]"
            echo ""
            echo "è¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è®¾ç½®:"
            echo "  gh secret set DEEPSEEK_API_KEY --repo Gsaecy/Gsaecy.github.io --body \"sk-a58836f7f3f043508ecf4edbac67be57\""
            exit 1
          fi
          
          echo "âœ… Secretå·²è®¾ç½®!"
          echo "   Keyé•¿åº¦: ${#TEST_KEY} å­—ç¬¦"
          echo "   Keyå‰10ä½: ${TEST_KEY:0:10}..."
          
          # ç®€å•éªŒè¯Keyæ ¼å¼
          if [[ "$TEST_KEY" == sk-* ]]; then
            echo "âœ… Keyæ ¼å¼æ­£ç¡® (ä»¥'sk-'å¼€å¤´)"
          else
            echo "âš ï¸  Keyæ ¼å¼å¯èƒ½ä¸æ­£ç¡® (åº”è¯¥ä»¥'sk-'å¼€å¤´)"
            echo "   å½“å‰Key: ${TEST_KEY:0:20}..."
          fi
          
          echo ""
          echo "ðŸŽ‰ Secretæµ‹è¯•é€šè¿‡!"
          echo "çŽ°åœ¨å¯ä»¥è¿è¡Œå®Œæ•´å·¥ä½œæµäº†ã€‚"
      
      - name: Test API Connection (å¯é€‰)
        if: github.event.inputs.test_type == 'api'
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          echo "ðŸ” æµ‹è¯•DeepSeek APIè¿žæŽ¥..."
          echo "=========================="
          
          # å®‰è£…requests
          pip install requests
          
          python3 -c "
import os, requests, json, sys

api_key = os.getenv('DEEPSEEK_API_KEY')
print(f'ä½¿ç”¨Key: {api_key[:10]}...')

try:
    headers = {
        'Authorization': f'Bearer {api_key}',
        'Content-Type': 'application/json'
    }
    
    # éžå¸¸ç®€å•çš„æµ‹è¯•è¯·æ±‚
    data = {
        'model': 'deepseek-chat',
        'messages': [{'role': 'user', 'content': 'Say OK'}],
        'max_tokens': 5,
        'temperature': 0.1
    }
    
    print('å‘é€æµ‹è¯•è¯·æ±‚...')
    response = requests.post(
        'https://api.deepseek.com/chat/completions',
        headers=headers,
        json=data,
        timeout=20
    )
    
    print(f'HTTPçŠ¶æ€ç : {response.status_code}')
    
    if response.status_code == 200:
        result = response.json()
        print('âœ… APIè¿žæŽ¥æˆåŠŸ!')
        print(f'AIå›žå¤: {result[\"choices\"][0][\"message\"][\"content\"]}')
        print(f'ä½¿ç”¨token: {result[\"usage\"][\"total_tokens\"]}')
        sys.exit(0)
    else:
        print(f'âŒ APIè¯·æ±‚å¤±è´¥')
        print(f'çŠ¶æ€ç : {response.status_code}')
        print(f'é”™è¯¯ä¿¡æ¯: {response.text[:200]}')
        sys.exit(1)
        
except requests.exceptions.Timeout:
    print('âŒ è¯·æ±‚è¶…æ—¶ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜')
    sys.exit(1)
except Exception as e:
    print(f'âŒ æµ‹è¯•è¿‡ç¨‹å‡ºé”™: {e}')
    sys.exit(1)
          "
      
      - name: Generate Report
        if: always()
        run: |
          echo "# DeepSeek Secretæµ‹è¯•æŠ¥å‘Š" > report.md
          echo "æµ‹è¯•æ—¶é—´: $(date)" >> report.md
          echo "" >> report.md
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "## âœ… æµ‹è¯•æˆåŠŸ" >> report.md
            echo "" >> report.md
            echo "### ä¸‹ä¸€æ­¥æ“ä½œ:" >> report.md
            echo "1. **è¿è¡Œå®Œæ•´å·¥ä½œæµ**: .github/workflows/deepseek-secure.yml" >> report.md
            echo "2. **è®¿é—®åšå®¢**: https://gsaecy.github.io" >> report.md
            echo "3. **æŸ¥çœ‹çŠ¶æ€**: GitHub Actionsé¡µé¢" >> report.md
          else
            echo "## âŒ æµ‹è¯•å¤±è´¥" >> report.md
            echo "" >> report.md
            echo "### å¸¸è§é—®é¢˜:" >> report.md
            echo "1. **Secretæœªè®¾ç½®**: ä½¿ç”¨ gh secret set å‘½ä»¤" >> report.md
            echo "2. **Keyæ— æ•ˆ**: æ£€æŸ¥Keyæ ¼å¼å’Œé¢åº¦" >> report.md
            echo "3. **ç½‘ç»œé—®é¢˜**: æ£€æŸ¥ç½‘ç»œè¿žæŽ¥" >> report.md
          fi
          
          cat report.md