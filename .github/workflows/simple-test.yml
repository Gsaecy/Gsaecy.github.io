name: Simple Secret Test

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼'
        required: false
        default: 'check'
        type: choice
        options:
          - check
          - validate

env:
  PYTHON_VERSION: '3.11'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Check Secret Existence
        env:
          TEST_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          echo "ğŸ” æ£€æŸ¥GitHub Secret..."
          echo "=========================="
          
          if [ -z "$TEST_KEY" ]; then
            echo "âŒ é”™è¯¯: DEEPSEEK_API_KEY Secretæœªè®¾ç½®æˆ–ä¸ºç©º"
            echo ""
            echo "å¯èƒ½çš„åŸå› :"
            echo "1. Secretåç§°ä¸æ­£ç¡® (åº”è¯¥æ˜¯ DEEPSEEK_API_KEY)"
            echo "2. Secretå€¼æœªè®¾ç½®"
            echo "3. å·¥ä½œæµæƒé™é—®é¢˜"
            echo ""
            echo "è§£å†³æ–¹æ¡ˆ:"
            echo "1. ç¡®è®¤Secretåç§°: DEEPSEEK_API_KEY"
            echo "2. ä½¿ç”¨å‘½ä»¤æ£€æŸ¥: gh secret list --repo Gsaecy/Gsaecy.github.io"
            echo "3. é‡æ–°è®¾ç½®: gh secret set DEEPSEEK_API_KEY --repo Gsaecy/Gsaecy.github.io --body \"ä½ çš„API Key\""
            exit 1
          fi
          
          echo "âœ… Secretå­˜åœ¨!"
          echo "   Keyé•¿åº¦: ${#TEST_KEY} å­—ç¬¦"
          echo "   Keyæ ¼å¼: ${TEST_KEY:0:10}..."
          
          # æ£€æŸ¥æ ¼å¼
          if [[ "$TEST_KEY" != sk-* ]]; then
            echo "âš ï¸  è­¦å‘Š: Keyå¯èƒ½æ ¼å¼ä¸æ­£ç¡®"
            echo "   åº”è¯¥ä»¥ 'sk-' å¼€å¤´"
          else
            echo "âœ… Keyæ ¼å¼æ­£ç¡®"
          fi
          
          echo ""
          echo "ğŸ‰ Secretæ£€æŸ¥é€šè¿‡!"
          echo "ç°åœ¨å¯ä»¥è¿è¡Œå®Œæ•´çš„å·¥ä½œæµäº†ã€‚"
      
      - name: Validate API Key (å¯é€‰)
        if: github.event.inputs.test_mode == 'validate' && success()
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          echo "ğŸ” éªŒè¯API Keyæœ‰æ•ˆæ€§..."
          echo "=========================="
          
          # å®‰è£…requests
          pip install requests
          
          python3 -c "
import os, requests, json

key = os.getenv('DEEPSEEK_API_KEY')
print(f'éªŒè¯Key: {key[:10]}...')

try:
    # ç®€å•APIè°ƒç”¨æµ‹è¯•
    headers = {
        'Authorization': f'Bearer {key}',
        'Content-Type': 'application/json'
    }
    
    data = {
        'model': 'deepseek-chat',
        'messages': [{'role': 'user', 'content': 'Hello'}],
        'max_tokens': 5
    }
    
    print('å‘é€æµ‹è¯•è¯·æ±‚...')
    response = requests.post(
        'https://api.deepseek.com/chat/completions',
        headers=headers,
        json=data,
        timeout=15
    )
    
    print(f'çŠ¶æ€ç : {response.status_code}')
    
    if response.status_code == 200:
        print('âœ… API Keyæœ‰æ•ˆ!')
        result = response.json()
        print(f'AIå›å¤: {result[\"choices\"][0][\"message\"][\"content\"]}')
    elif response.status_code == 401:
        print('âŒ API Keyæ— æ•ˆæˆ–å·²è¿‡æœŸ')
        print('è¯·æ£€æŸ¥:')
        print('1. Keyæ˜¯å¦æ­£ç¡®')
        print('2. Keyæ˜¯å¦è¿˜æœ‰é¢åº¦')
        print('3. Keyæ˜¯å¦è¢«ç¦ç”¨')
    else:
        print(f'âš ï¸  å…¶ä»–é”™è¯¯: {response.status_code}')
        print(f'å“åº”: {response.text[:200]}')
        
except Exception as e:
    print(f'âŒ éªŒè¯è¿‡ç¨‹å‡ºé”™: {e}')
          "
      
      - name: Create Test Report
        if: always()
        run: |
          echo "# Secretæµ‹è¯•æŠ¥å‘Š" > test-report.md
          echo "ç”Ÿæˆæ—¶é—´: $(date)" >> test-report.md
          echo "" >> test-report.md
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "## âœ… æµ‹è¯•ç»“æœ: æˆåŠŸ" >> test-report.md
            echo "" >> test-report.md
            echo "### ä¸‹ä¸€æ­¥:" >> test-report.md
            echo "1. è¿è¡Œå®Œæ•´å·¥ä½œæµ: .github/workflows/deepseek-secure.yml" >> test-report.md
            echo "2. è®¿é—®åšå®¢: https://gsaecy.github.io" >> test-report.md
            echo "3. æŸ¥çœ‹è¿è¡ŒçŠ¶æ€: GitHub Actionsé¡µé¢" >> test-report.md
          else
            echo "## âŒ æµ‹è¯•ç»“æœ: å¤±è´¥" >> test-report.md
            echo "" >> test-report.md
            echo "### å¯èƒ½çš„é—®é¢˜:" >> test-report.md
            echo "1. Secretæœªè®¾ç½®" >> test-report.md
            echo "2. Secretåç§°ä¸æ­£ç¡®" >> test-report.md
            echo "3. ç½‘ç»œè¿æ¥é—®é¢˜" >> test-report.md
            echo "" >> test-report.md
            echo "### è§£å†³æ–¹æ¡ˆ:" >> test-report.md
            echo "1. æ£€æŸ¥Secret: gh secret list --repo Gsaecy/Gsaecy.github.io" >> test-report.md
            echo "2. é‡æ–°è®¾ç½®: gh secret set DEEPSEEK_API_KEY --repo Gsaecy/Gsaecy.github.io" >> test-report.md
            echo "3. æ£€æŸ¥Keyæ ¼å¼: åº”è¯¥ä»¥ 'sk-' å¼€å¤´" >> test-report.md
          fi
          
          cat test-report.md