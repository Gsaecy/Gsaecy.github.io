name: Minimal Secret Test

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Check Secret
        env:
          MY_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          echo "=== 最小化Secret测试 ==="
          echo ""
          echo "1. 检查环境变量..."
          echo "   变量名: MY_KEY"
          echo "   值: $MY_KEY"
          echo ""
          
          if [ -z "$MY_KEY" ]; then
            echo "❌ 错误: 环境变量为空"
            echo ""
            echo "可能原因:"
            echo "- Secret名称不匹配"
            echo "- 工作流权限问题"
            echo "- GitHub同步延迟"
            echo ""
            echo "当前Secret状态:"
            echo "  名称: DEEPSEEK_API_KEY"
            echo "  已设置: 是 (通过gh命令确认)"
            echo ""
            echo "建议:"
            echo "1. 等待几分钟让GitHub同步"
            echo "2. 重新运行工作流"
            echo "3. 检查工作流权限"
            exit 1
          fi
          
          echo "✅ 环境变量获取成功!"
          echo ""
          echo "2. 检查Key信息..."
          echo "   长度: ${#MY_KEY} 字符"
          echo "   前10位: ${MY_KEY:0:10}"
          echo "   格式检查:"
          
          if [[ "$MY_KEY" == sk-* ]]; then
            echo "   ✅ 格式正确 (以'sk-'开头)"
          else
            echo "   ⚠️  格式可能有问题"
            echo "   实际开头: ${MY_KEY:0:3}"
          fi
          
          echo ""
          echo "3. 测试完成!"
          echo "   ✅ Secret工作正常"
          echo "   ✅ 可以运行完整工作流"
          echo ""
          echo "下一步:"
          echo "   运行 deepseek-secure.yml"
          
      - name: Simple Python Test
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          echo "=== Python环境测试 ==="
          python3 -c "
import os
key = os.getenv('DEEPSEEK_API_KEY')
if key:
    print(f'✅ Python获取Key成功')
    print(f'   长度: {len(key)}')
    print(f'   格式: {key[:10]}...')
else:
    print('❌ Python未获取到Key')
    print('   环境变量名: DEEPSEEK_API_KEY')
    print('   值: None')
          "